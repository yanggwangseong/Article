
> 필자는 이전에 다녔던 회사에서 linux에서 관리하는 회사에서 사용하는 sendMail 기반의 메일서버를 직접 운영 해본 경험과 회사에서 진행하는 프로젝트에서 자주 사용되는 기능중 하나인 메일 전송에 관한 이슈를 1년동안 고통을 받으며 결국 해결한 경험이 있습니다. 그 기간동안 Kisa, daum, naver, 회사 메일 주소라면 해당 회사의 전산팀등에게 적극적으로 커뮤니케이션을 요청 하였고 해당 부분들을 이제와서 정리 하게 되었지만 현재 저의 프로젝트에서도 간단한 회원가입 인증 코드를 발송하는 기능이 있어서 이번 기회에 확실히 정리하고자 하여 글을 작성하게 되었습니다.

# AWS SES에서 ISP에서 발생하는 문제

> 쉽게 추적해서 해결 할 수 있는 문제와 생각보다 백엔드 개발자들이 어려움을 겪는 문제 2가지가 존재한다.
> *Hard Bounce* 와 *Soft Bounce* 이다.


- 그림
- APP -> AWS SES () -> AWS SES에서의 `from domian` from domain의 SPF레코드 DKIM등의 레코드등을 그대로 활용해서 전송 합니다. **(여기서 발생하는 에러들이 Hard Bounce)**  -> ISA(Incoming Server Agent), 여기서 발생하는 문제가 **Soft Bounce이고 추적하기 힘듭니다.** -> Receive Server (구글, 네이버, 다음, 카카카오 등) -> 사용자 이메일 받을 메일함 도착.

## Hard Bounce

> 해결방법
> Cloud Watch 적극 이용 공식문서에 어떤 metric을 확인 해야 되는지 자세히 나옵니다.
> 애플리케이션에서 exception 터졌을때의 에러 상태코드와 에러 메세지 확인
> 보통 위의 두 방법으로 해결 됩니다.

- Cloud Watch나 애플리케이션에서 exception을 통해서도 쉽게 message를 통해서 에러추적이 가능한 오류로 메일 반송 되거나 사용자 이메일 주소가 존재하지 않거나 하는 쉽게 추적이 가능한 오류다.

## Soft Bounce

> 해결방법
> 수신자가 회사메일 주소라면 그 회사메일의 전산팀에도 확인이 필요하다. (제일 까다로운 케이스)
> 네이버,카카오,다음,구글 같은 기업들 같은 경우에는 DNS 레코드 설정만 잘 해두면 해결이 가능하다.

- Soft Bounce 문제는 파악하기 힘들고 보통 ISP에서 재전송이 일어나면서 이때 *12시간* 동안 제한없는 메일 전송 재시도가 발생한다.
- 이런 경우에 보통 메일을 전송 했을때 고유 Id값을 가지고 AWS에 문의해서 추적을 요청 해야한다.
- 이미 애플리케이션에서 호출이 되고 AWS SES에서도 떠난 메일은 ISP에서 전송을 하는데 여기서 어떠한 이유로 재전송이 일어나면서 길게는 12시간 안에 도착하거나 하는지 확인 하는 방법은 애플리케이션 레벨에서는 존재 하지 않는다.
- 그렇기 때문에 이 문제를 접했을때 어떤것들을 점검 해야 되는지만 잘 알고 있으면 해당 문제들을 하나씩 해결하고 적용해 나가면서 소거해 나가다보면 충분히 해결 할 수 있는 문제이다.
- AWS 공식문서에는 이러한 방법들이 자세히 나와있고 *이메일을 전송하는 대상 국가와 리전의 이메일 마케팅 및 스팸 방지 법률과 규정에 대해서 잘 알고 있어야 합니다. 사용자는 전송하는 이메일이 이러한 법률을 준수하는지 확인할 책임이 있습니다.* 
- 거의 Soft Bounce문제는 내 생각에는 규정을 준수하지 않았기 때문에 발생한다고 생각한다.
- *왜 Soft Bounce 문제는 해결이 어려운가?*
	- 이미 메일이 APP에서 떠나고 AWS SES에서 떠났고 ISP에서 재전송이 계속 발송 하고 있는 상태이기 때문입니다.
	- 즉, sender입장에서는 뭐가 문제인지 파악하기가 굉장히 어렵다는 얘기입니다.
	- 크롬 브라우저에 접속한 유저의 문제를 저희가 완벽하게 디버깅 할 수 없는것과 같은 맥락이죠.

- 의문점)
	- 그렇다면 반송이 되거나 스팸함에 들어가는게 아니라 왜 결국에 오래 걸리더라도 메일은 도착 하는가?
	- 모든 ISP가 즉시 반송(Bounce)하지는 않는다.
	- 수신 서버가 엄격한 경우
		- 오히려 감사한 일입니다. *Hard Bounce* 처리를 해주어서 Sender 입장에서 무엇이 잘못 되었는지 기입해둔 반송 메일로 받아 볼 수 있습니다.
	- 수신 서버가 엄격하지 않을 경우
		- 일부 수신 메일 서버는 SPF/DKIM 검증이 실패해도 완전히 차단(Reject)하지 않고, Soft Fail (4xx)로 처리합니다.
		-  즉, 일시적인 문제라고 간주하고 ISP가 다시 시도할 수 있도록 응답을 보냄.
		- 결론적으로 ISP에서 계속 재시도하다가, 일정 횟수 내에서 전송이 되면 메일이 정상적으로 도착할 수도 있습니다.
		- 물론, 스팸함에 들어가거나 결국 반송되거나 할 수 도 있는거죠. 또는 이를 해결하지 않다보면 결국 IP블랙리스트가 될 수 도 있습니다.
	- Greylisting (회색 목록) 정책 때문
		- 일부 수신 서버는 처음 본 발신 서버(IP)에 대해 고의적으로 "일시적인 실패(4xx)" 응답을 보내고, 재전송이 올 경우 정상적으로 허용하는 "Greylisting" 기법을 사용합니다.
		- *핵심은 스팸 발송자가 **일반적으로 재전송을 하지 않는다는 특징**을 이용하여 정당한 메일과 스팸 메일을 구분하는 방식* 
		- 즉, Sender가 신원보증 문제를 해결하지 않았지만 스팸은 아니다라는걸 필터링 합니다. 그래서 다시 시도하다보면 메일이 수신 될 수 도 있습니다.
		- 이것도 위와 똑같이 스팸, 블랙리스트, Bounce될지 우리 Sender 입장에서는 모릅니다.
- 결론)
	- 수신 서버의 메일 서버를 담당하는 분이 천사라면 어떤걸 하면 되는지 알려 줄 가능성은 있지만 그럴 가능성은 높지 않습니다. 하지만 정확히 어떤것이 문제인지 알고 있고 어느 부분까지 고려하고 다른 곳들에서는 이러한 것을 통해서 해결이 되었는데 귀사의 메일 수신 서버에서는 매우 엄격한 규칙이 있으신지 아니면 그냥 모든 inbound 자체를 막으셨는지에 대한 질문을 한다면 수신하는 서버 담당자가 확인 안해줄리 만무하다고 생각합니다.
	- 또한 사내메일을 쓰는 사용자가 1천만명이고 거기에 회사만 100만배라면 이는 그 회사들에 몇번이나 전화를 해야할지 까마득합니다.
	- 메일전송 관련 문제는 항상 따라다니는 이슈이고 예를 들어 `mailgun` 처럼 해당 메일 전송만 제공하는 유료 서비스에서 조차도 종종 Bounce 문제가 발생 하기 떄문에 100% 해결이라는것은 없습니다.


# Reference

- https://en.wikipedia.org/wiki/Email_spam_legislation_by_country