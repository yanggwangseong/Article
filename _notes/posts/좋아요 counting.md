---
title: 좋아요 counting
permalink: /posts/좋아요 counting
---

# 미리 알아두면 좋은 내용

- [[_notes/wating/데이터베이스/Lock]]

- 이전에 비해 article 조회 api의 성능은 눈에 띄게 좋아졌다. 하지만 여기에서 문제점이 하나 있는데 그건 바로 좋아요 개수를 가져오는 부분이다.
- 현재의 데이터 개수로는 아직까지 문제가 없지만 정말 많은 좋아요 개수가 있다면 결국 게시글 리스트를 가져올때 좋아요 총 개수도 함께 가져오기 때문에 성능 저하를 발생시킬 가능성이 높다.
- 이문제를 해결 하기 위해서 여러가지 방법들이 존재 하지만 현재 시스템에서 해결할 수 있는 최선의 방법을 생각 해보았다.
- 좋아요의 총 개수를 게시물 필드에 포함하는 반정규화 방법을 선택 하였다. 그래서 좋아요 개수의 총 개수를 아티클 필드에 like_count를 추가하여 조회시에 좋아요 개수를 가져오는 부분을 제거 하였습니다.
- articles 테이블에 좋아요 개수를 `select` 한후에 update를 하게 되면 Lost Update (갱신 분실) 문제가 발생 합니다.
	- articles 테이블에 `UPDATE articles SET like_count = like_count + 1 WHERE id = 1;` like_count 자체를 읽어서 +1 해주는 방법.
		- **행 수준 잠금(Row-Level Lock)** 문제가 발생합니다.
			- `id = 1` 특정 게시물에 한해서 행 수준 잠금으로 인해서 좋아요처럼 해당 특정 게시물에 여러명이 좋아요를 할 수 있는 상황에서는 잠금 대기로 인해 성능 저하가 발생 합니다.
	- 낙관적 잠금을 통해서 해결 해보기. (여기까지 적용하고 아래는 이후에 개선 할 수 있는 여지로 남기기)
	- 개선 방향성
		- 좋아요 업데이트의 실시간성 반영을 줄이고 배치 작업을 통해서 해결하기
			- 같은 데이터로 동기화 하는방법 궁극적 일관성(Eventual Consistency)
			- 배치 서버가 필요하다.