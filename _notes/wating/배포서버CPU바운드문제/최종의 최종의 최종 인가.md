---
title: mokakbab-issue
permalink: /wating/k6/1
---
- https://grafana.com/docs/k6/latest/testing-guides/running-large-tests/
- https://grafana.com/docs/k6/latest/using-k6/http-requests/#url-grouping
- https://grafana.com/docs/k6/latest/set-up/fine-tune-os/
- https://grafana.com/docs/k6/latest/using-k6/javascript-typescript-compatibility-mode/



- **리눅스 서버의 네트워크 및 파일 디스크립터 제한** 때문에 K6 부하 테스트와 같은 대규모 테스트에서 성능 문제가 발생할 가능성

현재 `ulimit -n` 값이 **1024**로 설정되어 있습니다.

```
ulimit -n 250000
```


```
sysctl -w net.ipv4.ip_local_port_range="1024 65535"  # 로컬 포트 범위 확장
sysctl -w net.ipv4.tcp_tw_reuse=1                  # TIME_WAIT 소켓 재사용 활성화
sysctl -w net.ipv4.tcp_timestamps=1                # TCP 타임스탬프 활성화
sysctl -w net.ipv4.tcp_max_syn_backlog=4096        # SYN 요청 큐 크기 증가
sysctl -w net.core.somaxconn=4096                  # 최대 대기 연결 큐 크기 증가
sysctl -w net.core.netdev_max_backlog=5000         # 네트워크 백로그 큐 크기 증가
```

```
docker run --ulimit nofile=250000:250000 my-container
```


```
k6 run participations-performance.js --env BASE_URL="http://27.96.130.212" --env ACCESS_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJfMTczNDEwNDQ3NDMzM19pN3BwcXdAdW53aWxsaW5nLWF0dGljLm5hbWUiLCJzdWIiOjEsInR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3MzYwMzM1NDAsImV4cCI6MTczNjA0MTMxNn0.-1V4Z7kkTEW0-Ss8pTB359-GQc6NFDIeKxMc-NAFWj8"
```

```
k6 run articles-performance.js --env BASE_URL="http://27.96.130.212" --env ACCESS_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJfMTczNDEwNDQ3NDMzM19pN3BwcXdAdW53aWxsaW5nLWF0dGljLm5hbWUiLCJzdWIiOjEsInR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3MzYwMjY2MDIsImV4cCI6MTczNjAzNDM3OH0.g2OIBG-B2jvyUi63fhL4s6-R0C8AXWcT4PQq9RetzRI"
```

```
k6 run upload-image-performance.js --env BASE_URL="http://27.96.130.212:3000" --env ACCESS_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJfMTczNDEwNDQ3NDMzM19pN3BwcXdAdW53aWxsaW5nLWF0dGljLm5hbWUiLCJzdWIiOjEsInR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3MzYwMzI1MDAsImV4cCI6MTczNjA0MDI3Nn0.PkPvgJs9n7fCrCdRZ0ZUv6kHiMT9eCsUQo36drhtJc8"
```
# 핵심

```
MySQL2 Connection Pool: { total: 100, idle: 0, waitingClients: 812 }
MySQL2 Connection Pool: { total: 100, idle: 0, waitingClients: 810 }
MySQL2 Connection Pool: { total: 100, idle: 0, waitingClients: 808 }
MySQL2 Connection Pool: { total: 100, idle: 0, waitingClients: 806 }
```

```ts
extra: {
	connectionLimit: 100,
	waitForConnections: true,
	queueLimit: 0,
} as PoolOptions,
```

- typeORM connectionLimit 저부분이랑 동일하다!!!!


### **문제 해결 방안**

#### **1. 클라이언트(맥북) 측 조치**

- **임시 포트 범위 늘리기**:
    
    bash
    
    코드 복사
    
    `sudo sysctl -w net.inet.ip.portrange.first=32768`
    
    이를 통해 포트 부족 문제를 완화할 수 있습니다.
    
- **`TIME_WAIT` 포트 재사용 설정**:
    
    bash
    
    코드 복사
    
    `sudo sysctl -w net.inet.tcp.reuseport=1`
    

#### **2. 서버(리눅스) 측 조치**

- **임시 포트 범위 늘리기**:
    
    bash
    
    코드 복사
    
    `sudo sysctl -w net.ipv4.ip_local_port_range="16384 65000"`
    
- **TCP 연결 재사용 활성화**:
    
    bash
    
    코드 복사
    
    `sudo sysctl -w net.ipv4.tcp_tw_reuse=1`
    
- **네트워크 큐 크기 확장**:
    
    bash
    
    코드 복사
    
    `sudo sysctl -w net.core.somaxconn=1024 sudo sysctl -w net.ipv4.tcp_max_syn_backlog=4096`
    

#### **3. 네트워크 상태 확인**

- `iftop`으로 클라이언트와 서버 간 트래픽 사용량을 실시간으로 모니터링하여 병목 현상이 있는지 확인합니다.
- 서버의 `/proc/net/dev`와 `netstat -s` 명령을 사용하여 **패킷 드롭**이나 **전송 실패**가 발생하는지 확인하세요:
    
    bash
    
    코드 복사
    
    `netstat -s | grep -i drop`
    

#### **4. 부하 테스트 설정 조정**

- **VUs와 요청 속도 조정**:
    - 너무 많은 VUs를 동시에 생성하거나, 초당 요청 수를 지나치게 높게 설정하면 포트 부족 문제와 네트워크 병목이 심화됩니다.
    - 테스트 속도를 점진적으로 늘리며 문제 발생 여부를 확인하세요.


# 서버 리눅스 측

임시 포트 범위 확인

```
sysctl net.ipv4.ip_local_port_range

```


- TCP 재사용 설정 확인

```
sysctl net.ipv4.tcp_tw_reuse

1이여야함
```

- 대기 연결 큐 크기 확인(SYN 대기열 크기)

```
sysctl net.ipv4.tcp_max_syn_backlog
```

- sysctl net.core.somaxconn

```
net.core.somaxconn = 128
```


- TIME_WAIT 연결 수 확인

```
netstat -nat | grep TIME_WAIT | wc -l
```

- 패킷 드롭 확인
```
netstat -s | grep -i drop
```

- 네트워크 인터페이스 트래픽 상태 확인

```
cat /proc/net/dev
```



```
MySQL2 Connection Pool: { total: 201, idle: 160, waitingClients: 0 }
MySQL2 Connection Pool: { total: 201, idle: 161, waitingClients: 0 }
[Nest] 25  - 01/04/2025, 11:22:51 PM   ERROR [GlobalExceptionFilter] Exception: Too many connections
Error: Too many connections
    at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:740:17)
    at ClientHandshake.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26)
    at PoolConnection.handlePacket (/app/node_modules/mysql2/lib/base/connection.js:475:34)
    at PacketParser.onPacket (/app/node_modules/mysql2/lib/base/connection.js:93:12)
    at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16)
    at Socket.<anonymous> (/app/node_modules/mysql2/lib/base/connection.js:100:25)
    at Socket.emit (node:events:524:28)
    at Socket.emit (node:domain:489:12)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
[Nest] 25  - 01/04/2025, 11:22:51 PM   ERROR [GlobalExceptionFilter] Exception: Too many connections
Error: Too many connections
    at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:740:17)
    at ClientHandshake.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26)
    at PoolConnection.handlePacket (/app/node_modules/mysql2/lib/base/connection.js:475:34)
    at PacketParser.onPacket (/app/node_modules/mysql2/lib/base/connection.js:93:12)
    at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16)
    at Socket.<anonymous> (/app/node_modules/mysql2/lib/base/connection.js:100:25)
    at Socket.emit (node:events:524:28)
    at Socket.emit (node:domain:489:12)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
MySQL2 Connection Pool: { total: 199, idle: 162, waitingClients: 0 }
MySQL2 Connection Pool: { total: 199, idle: 163, waitingClients: 0 }
MySQL2 Connection Pool: { total: 199, idle: 164, waitingClients: 0 }
MySQL2 Connection Pool: { total: 199, idle: 165, waitingClients: 0 }
MySQL2 Connection Pool: { total: 199, idle: 167, waitingClients: 0 }
[Nest] 25  - 01/04/2025, 11:22:51 PM   ERROR [GlobalExceptionFilter] Exception: Too many connections
Error: Too many connections
    at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:740:17)
    at ClientHandshake.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26)
    at PoolConnection.handlePacket (/app/node_modules/mysql2/lib/base/connection.js:475:34)
    at PacketParser.onPacket (/app/node_modules/mysql2/lib/base/connection.js:93:12)
    at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16)
    at Socket.<anonymous> (/app/node_modules/mysql2/lib/base/connection.js:100:25)
    at Socket.emit (node:events:524:28)
    at Socket.emit (node:domain:489:12)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
[Nest] 25  - 01/04/2025, 11:22:51 PM   ERROR [GlobalExceptionFilter] Exception: Too many connections
Error: Too many connections
    at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:740:17)
    at ClientHandshake.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26)
    at PoolConnection.handlePacket (/app/node_modules/mysql2/lib/base/connection.js:475:34)
    at PacketParser.onPacket (/app/node_modules/mysql2/lib/base/connection.js:93:12)
    at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16)
    at Socket.<anonymous> (/app/node_modules/mysql2/lib/base/connection.js:100:25)
    at Socket.emit (node:events:524:28)
    at Socket.emit (node:domain:489:12)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
[Nest] 25  - 01/04/2025, 11:22:51 PM   ERROR [GlobalExceptionFilter] Exception: Too many connections
Error: Too many connections
    at Packet.asError (/app/node_modules/mysql2/lib/packets/packet.js:740:17)
    at ClientHandshake.execute (/app/node_modules/mysql2/lib/commands/command.js:29:26)
    at PoolConnection.handlePacket (/app/node_modules/mysql2/lib/base/connection.js:475:34)
    at PacketParser.onPacket (/app/node_modules/mysql2/lib/base/connection.js:93:12)
    at PacketParser.executeStart (/app/node_modules/mysql2/lib/packet_parser.js:75:16)
    at Socket.<anonymous> (/app/node_modules/mysql2/lib/base/connection.js:100:25)
    at Socket.emit (node:events:524:28)
    at Socket.emit (node:domain:489:12)
    at addChunk (node:internal/streams/readable:561:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)

```