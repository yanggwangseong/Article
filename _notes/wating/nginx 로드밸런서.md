---
title: nginx로드밸런서
permalink: /wating/nginx
---


- `900kb` 이하의 이미지 몇개를 업로드 시키는 api에 테스트를 했을때 2~3천 정도의 리퀘스트를 테스트 해도 될것 같다. 이렇게 테스트를 해보고 얼마나 나오는지 확인 해보라는게 어떤게 얼마나 나오는지 확인.

- 2025-01-01
	- `Blob Storage` 를 사용하는 코드로 변경
	- 확장 가능한 서버 -> 무상태성을 갖는 서버
	- 무상태 서버 학습, 서버에 상태를 유지하는게 있는지 학습
	- 서버 자체가 여러 개로 확장될 수 있어야한다. -> 무상태성을 갖는 서버이냐 확인

# 개요

- Multer를 통한 이미지 업로드 기능을 사용 시 최대 RPS가 200이 한계 였다.
- 이를 해결 하기 위해서 서버를 수평적 확장(scale out) 할 필요가 있었다.
- 서버를 확장 할때 문제.
	- 수평적 확장으로 각각의 서버에 이미지 파일을 저장하게 되면 예를 들어 A에 파일을 저장하고 B에 해당 파일 읽기 요청을 보낸다면 B에서 A에 파일 요청을 보내야 한다.
	- 즉, 서버가 N개로 늘어 났을때 N-1개 만큼 서버를 뒤져서 찾아야 한다.
	- 확장 가능한 서버는 무엇일까? 무상태성을 갖는 서버이다.
		- 현재 프로젝트에서 상태를 유지하는게 있는지 확인.
		- 이미지 파일들을 서버에 업로드 하기 때문에 상태를 유지 해야 하기 때문에 이는 무상태성을 갖는 서버가 아니다.
- 이를 해결 하기 위해서 스토리지를 사용한다.
- 서버가 무상태성을 갖는 서버라면 스케일 아웃 한다.
- 현재 클라우드 환경에서 로드밸런서와 오토 스케일링그룹을 통해서 서버를 수평적 확장 할 수 있지만 비용 문제가 발생하기 떄문에 Nginx와 docker-compose를 통해서 로드 밸런서와 수평적 확장을 구현한다.

### **이미지 업로드 기능과 서버 확장의 필요성**

1. **현황 및 문제점**
    - 현재 Multer를 사용하여 이미지 업로드 기능을 제공하고 있으며, 최대 RPS(초당 요청 처리량)는 200이 한계였습니다.
    - 이를 해결하기 위해 서버를 수평적으로 확장(**Scale-Out**)해야 하는 상황입니다.
2. **서버 확장 시 문제점**
    - 수평적 확장으로 인해 각 서버에 이미지 파일이 분산 저장되면 문제가 발생합니다.
        - 예: 서버 A에 파일이 저장되었으나, 서버 B에서 해당 파일을 요청할 경우 B는 A로부터 파일을 다시 요청해야 합니다.
        - 서버가 N개로 늘어날수록 최대 N-1개의 서버를 탐색해야 하므로 효율이 떨어집니다.
    - 이로 인해 **상태(State)** 를 유지해야 하는 서버는 무상태성(Stateless)을 유지하지 못하게 됩니다.
3. **무상태성(Stateless)의 중요성**
    - 확장 가능한 서버는 무상태성을 유지해야 합니다.
    - 현재 프로젝트에서 상태를 유지하는 요소를 확인한 결과:
        - 이미지 파일을 서버에 직접 업로드하고 있으므로, 이는 상태를 유지하는 서버입니다.
    - 따라서, 서버가 무상태성을 가지도록 설계 변경이 필요합니다.
4. 해결책: 스토리지 활용
    - 서버가 무상태성을 갖도록 이미지 파일 저장소를 서버 외부에 두는 방안을 고려합니다.
    - 클라우드 기반 스토리지(AWS S3, GCP Cloud Storage 등)를 활용하거나, 독립적인 파일 서버를 구축합니다.
5. 서버 확장 방식
    - 무상태성을 유지하는 서버라면 수평적 확장을 통해 문제를 해결할 수 있습니다.
    - 클라우드 환경에서는 로드 밸런서와 오토 스케일링 그룹을 통해 수평적 확장을 구현할 수 있으나, 비용 문제가 발생할 수 있습니다.
    - 비용 효율성을 고려하여 **Nginx**와 **Docker Compose**를 사용해 로드 밸런서와 수평적 확장을 직접 구현합니다.

# Reference

- [Nginx 사용 로드밸런싱](https://hudi.blog/load-balancing-with-nginx/) 
- [AWS SDK NCP ObjectStorage 사용](https://guide.ncloud-docs.com/docs/storage-storage-8-4) 




