---
title: ch-16-Query-Optimization
permalink: /cs/database/database-system-7th/ch-16-Query-Optimization
tags:
  - Database
layout: page
---

## Query Optimization

- Query Optimization이란?
	- 쿼리를 효율적으로 처리하기 위한 방법을 찾아내는 과정
- 왜 필요할까?
	- 실제 사용자가 작성한 쿼리가 수행되는 실행 계획은 여러가지이고 어떤 실행 계획대로 실행해야 해당 쿼리를 최적으로 수행 할 수 있는지 결정하는것은 Optimizer 즉, 데이터 베이스 시스템이 결정한다.
- 1) 관계형 표현식의 변환
	- 동등 규칙
	- 조인 순서
	- 동등한 표현식의 열거
- 2) 결과에 대한 통계 추정
	- 카탈로그 정보
	- 선택 크기 추정
	- 조인 크기 추정
	- 다른 연산에 대한 크기 추정
	- 서로 다른 값의 개수에 대한 추정
- 3) 평가 계획의 선택
	- 비용 기반 조인 순서 선택
	- 동등 규칙을 이용한 비용 기반 최적화
	- 휴리스틱을 통한 최적화
	- 중첩된 하위 쿼리의 최적화


- **관계형 표현식의 변환**:
    - **동등 규칙**: 쿼리의 조건이 동등한 형태로 변환될 수 있는지 평가합니다. 예를 들어, `A = B`와 `B = A`가 동등하다는 규칙을 적용하여 쿼리를 최적화합니다.
    - **조인 순서**: 여러 테이블 간의 조인 순서를 결정하는 과정입니다. 이 순서에 따라 쿼리 성능이 크게 달라질 수 있습니다.
- **결과에 대한 통계 추정**
    - **카탈로그 정보**: 테이블과 컬럼에 대한 메타데이터와 통계 정보를 사용하여 실행 계획을 세울 때 고려됩니다.
    - **선택 크기 추정**: 조건을 만족하는 레코드 수를 추정합니다.
    - **조인 크기 추정**: 조인된 테이블의 크기와 그 결과를 예측합니다.
    - **다른 연산에 대한 크기 추정**: 예를 들어, 그룹화나 집계 함수의 결과 크기를 추정합니다.
    - **서로 다른 값의 개수에 대한 추정**: 데이터의 분포를 기반으로 값의 다양성(예: DISTINCT)에 대해 예측합니다.
- **평가 계획의 선택**:
	- **비용 기반 조인 순서 선택**: 쿼리 옵티마이저는 각 가능한 조인 순서에 대해 예상되는 비용을 계산하고 가장 비용이 적은 순서를 선택합니다.
	- **동등 규칙을 이용한 비용 기반 최적화**: 동등 관계를 이용해 데이터를 재구성하여 비용을 줄일 수 있는 방법을 찾습니다.
	- **휴리스틱을 통한 최적화**: 통상적으로 잘 알려진 최적화 방법(예: 작은 테이블 먼저 조인)을 기반으로 빠르게 실행 계획을 선택합니다.
	- **중첩된 하위 쿼리의 최적화**: 서브쿼리를 풀거나 병합하여 성능을 최적화합니다.

## 쿼리 Optimizer

- 쿼리 Optimizer란?
	- 가장 효율적인 쿼리 계획을 선택하는 과정을 말합니다.
- 왜 필요할까?
	- 가장 적은 비용의 쿼리 **평가 계획** 을 찾기 위해서
	- 사용자가 작성한 쿼리가 효율적으로 처리될 수 있게 작성되지 않았을 가능성이 높기 때문에
- 어떻게?
	- 1) 표현식과 동등하면서 더 효율적으로 수행될 수 있는 표현식을 찾아낸다.
	- 2) 어떤 연산을 수행하기 위한 알고리즘선택이나 인덱스 사용등을 통해서 비용 추산
- 평가 계획이란?
	- 각 개별 연산에 어떤 알고리즘이 사용되어야 하는지
	- 연산의 수행이 어떤식으로 진행되어야 하는지
- 평가 계획을 어떻게 만들까?
	- 1) 논리적으로 주어진 표현식과 동등한 식을 만든다.
	- 2) 각 표현식에 `annotation` 을 달아 서로 다른 쿼리 평가 계획을 만든다.
	- 3) 각 평가 계획은 비용을 추정하고 비용이 가장 적은 것을 선택한다.
1. 관계형 표현식의 변환
	- 어떻게 변환 할까?
		- 동등 규칙을 만족하는 논리적으로 결과가 같은 표현식을 만듭니다.
	- 어떻게 동등한 다른 표현식을 만들까?
		- 동등 규칙을 통해서 만듭니다.
	- 동등 규칙(equivalence rule)이란?
		- 두 가지 형태의 표현식이 동등하다는 것을 나타낸다.
	- 어떻게?
		- 예를 들어 조인 순서 예시 설명
2. 비용 통계 추정
	- 카탈로그 정보
	- 선택 크기 추정
	- 조인 크기 추정
	- 다른 연산에 대한 크기 추정
	- 서로 다른 값의 개수에 대한 추정
3. 평가 계획 선택
	- 비용 기반 조인 순서 선택
	- 동등 규칙을 이용한 비용 기반 최적화
	- 휴리스틱을 통한 최적화
	- 중첩된 하위 질의의 최적화
